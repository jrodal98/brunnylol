{% extends "base.html" %}

{% block nav %}
<nav>
    <div>
        <a href="/">Home</a>
        <a href="/help">Help</a>
        <a href="/manage">My Bookmarks</a>
        {% if user.is_admin %}
        <a href="/admin">Admin</a>
        {% endif %}
    </div>
    <div style="display: flex; align-items: center; gap: 15px;">
        <span style="color: #ffffff;">{{ user.username }}</span>
        <a href="/settings">Settings</a>
        <form method="post" action="/logout" style="margin: 0;">
            <button type="submit">Logout</button>
        </form>
    </div>
</nav>
{% endblock %}

{% block content %}
<script src="https://unpkg.com/htmx.org@1.9.12" integrity="sha384-ujb1lZYygJmzgSwoxRggbCHcjc0rB2XoQrxeTUQyRjrOnlCoYta87iKBWq3EsdM2" crossorigin="anonymous"></script>

<style>
    .container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 20px;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #333;
    }

    .tabs {
        display: flex;
        gap: 10px;
        border-bottom: 3px solid #667eea;
        margin-bottom: 20px;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 8px 8px 0 0;
    }

    .tab {
        padding: 12px 24px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 16px;
        color: #495057;
        font-weight: 500;
        border-bottom: 3px solid transparent;
        border-radius: 4px 4px 0 0;
        transition: all 0.2s ease;
    }

    .tab:hover {
        background-color: rgba(102, 126, 234, 0.1);
        color: #667eea;
    }

    .tab.active {
        color: #667eea;
        font-weight: bold;
        border-bottom-color: #667eea;
        background-color: #ffffff;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
    }

    .form-group textarea {
        min-height: 60px;
        resize: vertical;
    }

    button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transition: all 0.2s ease;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
        transition: all 0.2s ease;
    }

    .btn-danger:hover {
        background-color: #c82333;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
        transition: all 0.2s ease;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
        transform: translateY(-1px);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
    }

    th, td {
        text-align: left;
        padding: 14px;
        border-bottom: 1px solid #e0e0e0;
    }

    th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #ffffff;
        font-weight: 600;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .conflict-warning {
        background-color: #fff3cd;
        color: #856404;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .success-message {
        background-color: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .nested-commands {
        margin-left: 20px;
        padding-left: 20px;
        border-left: 3px solid #e0e0e0;
    }

    .dynamic-field {
        display: none;
    }

    .dynamic-field.show {
        display: block;
    }
</style>

<div class="container">
    <div class="header">
        <div>
            <h1>Bookmark Management</h1>
            <p>Welcome, {{ user.username }}{% if user.is_admin %} (Admin){% endif %}</p>
        </div>
    </div>

    {% if has_conflicts %}
    <div class="conflict-warning">
        <strong>⚠️ Alias Conflicts Detected:</strong>
        Your personal bookmarks are overriding these built-in aliases: {{ conflicts_text }}
    </div>
    {% endif %}

    <div class="tabs">
        <button class="tab active" onclick="showTab('create')">Create Bookmark</button>
        <button class="tab" onclick="showTab('personal')">My Bookmarks</button>
        <button class="tab" onclick="showTab('global')">Built-in Bookmarks</button>
        {% if user.is_admin %}
        <button class="tab" onclick="showTab('admin')">Admin Panel</button>
        {% endif %}
    </div>

    <!-- Tab 1: Create Bookmark -->
    <div id="create" class="tab-content active">
        <h2>Create New Bookmark</h2>
        <div id="create-result"></div>

        <form hx-post="/manage/bookmark"
              hx-target="#create-result"
              hx-swap="innerHTML"
              id="create-bookmark-form"
              hx-on::before-request="prepareNestedCommands()"
              hx-on::after-request="if(event.detail.successful) { setTimeout(function() { window.location.reload(); }, 1000); }">
            <div class="form-group">
                <label for="alias">Alias *</label>
                <input type="text" id="alias" name="alias" required placeholder="e.g., gh" maxlength="50">
                <small>Shortcut you'll type to use this bookmark</small>
            </div>

            <div class="form-group">
                <label for="bookmark_type">Bookmark Type *</label>
                <select id="bookmark_type" name="bookmark_type" required onchange="toggleFields()">
                    <option value="simple">Simple Bookmark (static URL)</option>
                    <option value="templated">Search Template (URL with query)</option>
                    <option value="nested">Nested Commands</option>
                </select>
            </div>

            <div class="form-group">
                <label for="url">Base URL *</label>
                <input type="url" id="url" name="url" required placeholder="https://example.com">
                <small>The URL to redirect to (or base URL for search templates)</small>
            </div>

            <div class="form-group">
                <label for="description">Description *</label>
                <input type="text" id="description" name="description" required placeholder="What this bookmark does">
            </div>

            <!-- Fields for templated bookmarks -->
            <div id="templated-fields" class="dynamic-field">
                <div class="form-group">
                    <label for="command_template">Search Template *</label>
                    <input type="text" id="command_template" name="command_template" placeholder="https://example.com/search?q={}">
                    <small>Use {} as placeholder for search query</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="encode_query" value="true" checked>
                        URL-encode the query (uncheck for GitHub-style URLs with slashes)
                    </label>
                </div>
            </div>

            <!-- Info for nested bookmarks -->
            <div id="nested-info" class="dynamic-field">
                <h3>Sub-commands</h3>
                <p><em>Add sub-commands that will be accessible as: alias sub-alias query</em></p>

                <div id="nested-commands-list">
                    <!-- Dynamic nested command rows will be added here -->
                </div>

                <button type="button" onclick="addNestedRow();" class="btn-secondary" style="margin-top: 10px;">
                    + Add Sub-command
                </button>

                <!-- Hidden field for JSON data -->
                <input type="hidden" id="nested_commands_json" name="nested_commands_json">
            </div>

            <button type="submit" class="btn-primary">Create Bookmark</button>
        </form>
    </div>

    <!-- Tab 2: Personal Bookmarks -->
    <div id="personal" class="tab-content">
        <h2>My Personal Bookmarks</h2>

        {% if personal_count == 0 %}
        <p>You haven't created any personal bookmarks yet. Use the "Create Bookmark" tab to add one!</p>
        {% else %}
        <table>
            <thead>
                <tr>
                    <th>Alias</th>
                    <th>Type</th>
                    <th>URL/Template</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for bookmark in personal_bookmarks %}
                <tr id="bookmark-{{ bookmark.id }}">
                    <td><strong>{{ bookmark.alias }}</strong></td>
                    <td>{{ bookmark.bookmark_type }}</td>
                    <td>
                        {% if bookmark.command_template != "" %}
                            {{ bookmark.command_template }}
                        {% else %}
                            {{ bookmark.url }}
                        {% endif %}
                    </td>
                    <td>{{ bookmark.description }}</td>
                    <td>
                        <button class="btn-secondary"
                                onclick="showEditForm({{ bookmark.id }}, '{{ bookmark.alias }}', '{{ bookmark.url }}', '{{ bookmark.description }}', '{{ bookmark.command_template }}', {{ bookmark.encode_query }})">
                            Edit
                        </button>
                        <button class="btn-danger"
                                hx-delete="/manage/bookmark/{{ bookmark.id }}"
                                hx-target="#bookmark-{{ bookmark.id }}"
                                hx-swap="outerHTML swap:500ms"
                                hx-confirm="Are you sure you want to delete '{{ bookmark.alias }}'?">
                            Delete
                        </button>
                        {% if bookmark.bookmark_type == "nested" %}
                        <button class="btn-secondary" onclick="showNestedManager({{ bookmark.id }}, '{{ bookmark.alias }}')">
                            Manage Nested ({{ bookmark.nested_count }})
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>

    <!-- Tab 3: Global Bookmarks -->
    <div id="global" class="tab-content">
        <h2>Built-in Bookmarks</h2>
        <p>These are the global bookmarks loaded from commands.yml. You can override them by creating a personal bookmark with the same alias.</p>

        <table>
            <thead>
                <tr>
                    <th>Alias</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for bookmark in global_bookmarks %}
                <tr id="global-{{ bookmark.alias }}">
                    <td><strong>{{ bookmark.alias }}</strong></td>
                    <td>{{ bookmark.description }}</td>
                    <td id="status-{{ bookmark.alias }}">
                        {% if bookmark.is_overridden %}
                        <span style="color: #ff9800;">⚠️ Overridden by your personal bookmark</span>
                        {% else %}
                            {% if bookmark.is_disabled %}
                            <span style="color: #d32f2f;">✗ Disabled</span>
                            {% else %}
                            <span style="color: #4caf50;">✓ Active</span>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td>
                        <form hx-post="/manage/override"
                              hx-target="#global-{{ bookmark.alias }}"
                              hx-swap="outerHTML"
                              style="display: inline;">
                            <input type="hidden" name="builtin_alias" value="{{ bookmark.alias }}">
                            {% if bookmark.is_disabled %}
                            <button type="submit" class="btn-primary">Enable</button>
                            {% else %}
                            <input type="hidden" name="is_disabled" value="true">
                            <button type="submit" class="btn-secondary">Disable</button>
                            {% endif %}
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Tab 4: Admin Panel -->
    {% if user.is_admin %}
    <div id="admin" class="tab-content">
        <h2>Admin Panel</h2>
        <p>Manage users, view system statistics, and perform maintenance tasks.</p>
        <p><a href="/admin" class="btn-primary">Go to Admin Panel</a></p>
    </div>
    {% endif %}
</div>

<!-- Nested Command Manager Modal (will be shown via JavaScript) -->
<div id="nested-manager" style="display: none; position: fixed; top: 50px; left: 50%; transform: translateX(-50%); background: #ffffff; border: 2px solid #667eea; padding: 25px; border-radius: 12px; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3); max-width: 700px; width: 90%; z-index: 1000;">
    <h3 id="nested-manager-title" style="color: #667eea; margin-bottom: 20px;">Manage Nested Commands</h3>
    <div id="nested-manager-content"></div>
    <button onclick="hideNestedManager()" class="btn-secondary" style="margin-top: 15px;">Close</button>
</div>

<!-- Edit Bookmark Modal -->
<div id="edit-modal" style="display: none; position: fixed; top: 50px; left: 50%; transform: translateX(-50%); background: #ffffff; border: 2px solid #667eea; padding: 25px; border-radius: 12px; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3); max-width: 700px; width: 90%; z-index: 1000;">
    <h3 style="color: #667eea; margin-bottom: 20px;">Edit Bookmark</h3>
    <div id="edit-result"></div>
    <form id="edit-form" hx-put="" hx-target="#edit-result" style="margin-top: 15px;">
        <input type="hidden" id="edit-id" name="edit-id">

        <div class="form-group">
            <label>Alias:</label>
            <input type="text" id="edit-alias" name="alias" required>
        </div>

        <div class="form-group">
            <label>Base URL:</label>
            <input type="url" id="edit-url" name="url" required>
        </div>

        <div class="form-group">
            <label>Description:</label>
            <input type="text" id="edit-description" name="description" required>
        </div>

        <div class="form-group">
            <label>Search Template (optional):</label>
            <input type="text" id="edit-template" name="command_template">
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" id="edit-encode" name="encode_query" value="true">
                URL-encode query
            </label>
        </div>

        <button type="submit" class="btn-primary">Save Changes</button>
        <button type="button" onclick="hideEditForm()" class="btn-secondary">Cancel</button>
    </form>
</div>

<script>
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
}

function toggleFields() {
    const bookmarkType = document.getElementById('bookmark_type').value;
    const templatedFields = document.getElementById('templated-fields');
    const nestedInfo = document.getElementById('nested-info');

    // Hide all dynamic fields
    templatedFields.classList.remove('show');
    nestedInfo.classList.remove('show');

    // Show relevant fields
    if (bookmarkType === 'templated') {
        templatedFields.classList.add('show');
    } else if (bookmarkType === 'nested') {
        nestedInfo.classList.add('show');
    }
}

let nestedCounter = 0;

function addNestedRow() {
    console.log('addNestedRow called, counter:', nestedCounter);
    const container = document.getElementById('nested-commands-list');
    console.log('Container found:', container);
    if (!container) {
        alert('ERROR: nested-commands-list not found!');
        return;
    }
    const rowId = `nested-row-${nestedCounter++}`;
    console.log('Creating row:', rowId);

    const row = document.createElement('div');
    row.id = rowId;
    row.style.border = '2px solid #667eea';
    row.style.padding = '20px';
    row.style.marginBottom = '15px';
    row.style.borderRadius = '8px';
    row.style.backgroundColor = '#f8f9ff';
    row.style.boxShadow = '0 2px 8px rgba(102, 126, 234, 0.15)';

    row.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4 style="margin: 0; color: #667eea;">Sub-command #${nestedCounter}</h4>
            <button type="button" onclick="removeNestedRow('${rowId}')" class="btn-danger" style="padding: 6px 12px; font-size: 13px;">Remove</button>
        </div>

        <div class="form-group">
            <label>Sub-alias:</label>
            <input type="text" name="nested_alias[]" required placeholder="e.g., r" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>

        <div class="form-group">
            <label>Type:</label>
            <select name="nested_type[]" onchange="toggleNestedTemplate(this)" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                <option value="simple">Simple Bookmark</option>
                <option value="templated">Search Template</option>
            </select>
        </div>

        <div class="form-group">
            <label>URL:</label>
            <input type="url" name="nested_url[]" required placeholder="https://example.com" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>

        <div class="form-group">
            <label>Description:</label>
            <input type="text" name="nested_description[]" required placeholder="What this sub-command does" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>

        <div class="form-group nested-template-field" style="display: none;">
            <label>Template (with {}):</label>
            <input type="text" name="nested_template[]" placeholder="https://example.com/search?q={}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>

        <div class="form-group nested-encode-field" style="display: none;">
            <label>
                <input type="checkbox" name="nested_encode[]" value="true" checked>
                URL-encode query
            </label>
        </div>
    `;

    container.appendChild(row);
    console.log('Row appended to container, total children:', container.children.length);
}

function removeNestedRow(rowId) {
    document.getElementById(rowId).remove();
}

function toggleNestedTemplate(selectElement) {
    const row = selectElement.closest('div[id^="nested-row-"]');
    const templateField = row.querySelector('.nested-template-field');
    const encodeField = row.querySelector('.nested-encode-field');

    if (selectElement.value === 'templated') {
        templateField.style.display = 'block';
        encodeField.style.display = 'block';
    } else {
        templateField.style.display = 'none';
        encodeField.style.display = 'none';
    }
}

function prepareNestedCommands() {
    console.log('prepareNestedCommands called');
    const bookmarkType = document.getElementById('bookmark_type').value;
    console.log('Bookmark type:', bookmarkType);

    if (bookmarkType !== 'nested') {
        // Not a nested bookmark, clear the JSON field
        document.getElementById('nested_commands_json').value = '';
        console.log('Not nested, cleared JSON');
        return;
    }

    // Collect all nested command data
    const nestedCommands = [];
    const container = document.getElementById('nested-commands-list');
    const rows = container.querySelectorAll('div[id^="nested-row-"]');
    console.log('Found rows:', rows.length);

    rows.forEach((row, index) => {
        const aliasInput = row.querySelector('input[name="nested_alias[]"]');
        const typeSelect = row.querySelector('select[name="nested_type[]"]');
        const urlInput = row.querySelector('input[name="nested_url[]"]');
        const descInput = row.querySelector('input[name="nested_description[]"]');
        const templateInput = row.querySelector('input[name="nested_template[]"]');
        const encodeCheckbox = row.querySelector('input[name="nested_encode[]"]');

        nestedCommands.push({
            alias: aliasInput ? aliasInput.value : '',
            type: typeSelect ? typeSelect.value : 'simple',
            url: urlInput ? urlInput.value : '',
            description: descInput ? descInput.value : '',
            template: templateInput ? templateInput.value : null,
            encode: encodeCheckbox ? encodeCheckbox.checked : true
        });
    });

    // Serialize to JSON and set in hidden field
    const jsonValue = JSON.stringify(nestedCommands);
    document.getElementById('nested_commands_json').value = jsonValue;
    console.log('Prepared nested commands:', nestedCommands);
    console.log('JSON value:', jsonValue);
}

function showNestedManager(bookmarkId, alias) {
    document.getElementById('nested-manager-title').textContent = `Manage Nested Commands for '${alias}'`;

    // Load existing nested commands via HTMX
    const contentDiv = document.getElementById('nested-manager-content');
    contentDiv.innerHTML = `
        <div id="nested-list" hx-get="/manage/bookmark/${bookmarkId}/nested/list"
             hx-trigger="load, nested-added from:body"
             hx-swap="innerHTML">
            Loading...
        </div>

        <h4 style="margin-top: 20px;">Add New Sub-command</h4>
        <div id="nested-add-result" style="margin-bottom: 15px;"></div>
        <form hx-post="/manage/bookmark/${bookmarkId}/nested"
              hx-target="#nested-add-result"
              hx-swap="innerHTML"
              hx-on::after-request="if(event.detail.successful) { htmx.trigger('#nested-list', 'nested-added'); this.reset(); }"
              style="margin-top: 15px;">
            <input type="hidden" name="parent_id" value="${bookmarkId}">

            <div class="form-group">
                <label>Sub-alias:</label>
                <input type="text" name="alias" required placeholder="e.g., r">
            </div>

            <div class="form-group">
                <label>Type:</label>
                <select name="nested_type" onchange="toggleNestedFormFields(this)">
                    <option value="simple">Simple Bookmark</option>
                    <option value="templated">Search Template</option>
                </select>
            </div>

            <div class="form-group">
                <label>URL:</label>
                <input type="url" name="url" required placeholder="https://example.com">
            </div>

            <div class="form-group">
                <label>Description:</label>
                <input type="text" name="description" required>
            </div>

            <div class="form-group nested-template-field" style="display: none;">
                <label>Template (with {}):</label>
                <input type="text" name="command_template" placeholder="https://example.com/search?q={}">
            </div>

            <div class="form-group nested-encode-field" style="display: none;">
                <label>
                    <input type="checkbox" name="encode_query" value="true" checked>
                    URL-encode query
                </label>
            </div>

            <button type="submit" class="btn-primary">Add Sub-command</button>
        </form>
    `;

    document.getElementById('nested-manager').style.display = 'block';

    // Re-initialize HTMX on the new content
    htmx.process(contentDiv);
}

function toggleNestedFormFields(selectElement) {
    const form = selectElement.closest('form');
    const templateField = form.querySelector('.nested-template-field');
    const encodeField = form.querySelector('.nested-encode-field');

    if (selectElement.value === 'templated') {
        templateField.style.display = 'block';
        encodeField.style.display = 'block';
    } else {
        templateField.style.display = 'none';
        encodeField.style.display = 'none';
    }
}

function hideNestedManager() {
    document.getElementById('nested-manager').style.display = 'none';
}

function showEditForm(id, alias, url, description, template, encodeQuery) {
    document.getElementById('edit-id').value = id;
    document.getElementById('edit-alias').value = alias;
    document.getElementById('edit-url').value = url;
    document.getElementById('edit-description').value = description;
    document.getElementById('edit-template').value = template || '';
    document.getElementById('edit-encode').checked = encodeQuery;

    // Set the form action URL
    document.getElementById('edit-form').setAttribute('hx-put', `/manage/bookmark/${id}`);
    htmx.process(document.getElementById('edit-form'));

    document.getElementById('edit-modal').style.display = 'block';
}

function hideEditForm() {
    document.getElementById('edit-modal').style.display = 'none';
    document.getElementById('edit-result').innerHTML = '';
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded fired');
    toggleFields();

    // Add HTMX event listener to prepare nested commands before submission
    const createForm = document.getElementById('create-bookmark-form');
    console.log('Create form found:', createForm !== null);
    if (createForm) {
        createForm.addEventListener('htmx:configRequest', function(event) {
            console.log('htmx:configRequest event fired');
            prepareNestedCommands();
        });
        console.log('HTMX event listener added');
    }
});
</script>

{% endblock %}
